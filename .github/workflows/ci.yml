name: watchdog CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
    scan-and-push:
        name: Scan and push to ecr
        runs-on: ubuntu-latest

        env:
            ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
            AWS_REGION: ${{ secrets.AWS_REGION }}
            IMAGE_TAG: latest

        steps:
            - name: checkout
              uses: actions/checkout@v4.2.2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3.11.1
              
            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@0.28.0
              with:
                scan-type: 'fs'
                format: 'table'
                exit-code: '1'
                ignore-unfixed: true
                severity: 'CRITICAL,HIGH'
                timeout: '5m'
                scan-ref: '.'

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4.2.1
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY}}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
                aws-region: ${{ secrets.AWS_REGION }}    
            
            - name: Log in to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2.0.1

            - name: Build, tag, and push image to ECR
              run: |
               IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"
               docker build -t $IMAGE_URI .
               docker push $IMAGE_URI
    